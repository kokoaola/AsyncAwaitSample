# Swift Concurrency

## スレッドとは
PCやスマホのCPUに対して、タスクを割り当てる仕組みのこと。
CPUを効率よく使わないと、アプリのパフォーマンスが低下する。
複数のスレッドを独立させてCPUの割り当てることで、処理を同時に効率よく実行させていくことができ、パフォーマンスが向上する。

## キューとは
- タスクが実行されるまでの待ち行列のこと。一般的には、「先入れ先出し」（FIFO: First In, First Out）の原則で、最初に届いた処理から順番に実行される。
- タスクの待ち行列の管理、データの一時的な保管、タスクの順序付けなど、さまざまななプログラミング言語で広く使用されている概念
- スレッドは実行の「方法」に関わり、キューは実行される「タスクや順序」に関わる。スレッドとキューを組み合わせることで効率的なプログラムを作ることができる

## メインスレッドとバックグラウンドスレッド
1. メインスレッド
    - アプリ内で発生するすべての画面描写を担当するスレッドのこと。
    - アプリのユーザーインターフェイスで発生するすべての処理は、メインスレッドで処理されるため、処理が集中するとフリーズしたりする。
2. バックグラウンドスレッド
    - データの読み込み、ネットワークリクエスト、重い計算など、時間がかかる処理を担当するスレッドのこと。
    - アプリケーションの裏側で動作するため、メインスレッドのパフォーマンスを妨げない。


## Concurrencyという考え
- Concurrencyとは：同時並行処理、非同期処理とも言われる。複数のタスクを同時に実行したり、高速で切り替えながら実行すること。サンドイッチを食べながらプログラミングをする。友達と電話をしながら洗濯物を畳む
- スクロールなどのUIイベントと、画像のダウンロードをメインスレッドで同時に実行すると、ダウンロードが完了するまでUIイベントがフリーズしてしまう。これをを阻止するために、UIイベントのみをメインスレッドで、ダウンロードはバックグラウンドスレッドで分担させて必要がある。このように効率よく仕事を割り当てることがConcurrency（同時並行処理）



## Grand Central Dispatch (GCD)
### GCDとは
Swift、Objective-Cに組み込まれている平行処理のためのAPIのこと。タスクを複数のスレッドに割り当ててることで、アプリケーションのパフォーマンスを向上させる。

### ディスパッチキューとは
- GCD内で使用される特別なキューのこと
    - シリアルディスパッチキュー
        - FIFOの原則に従うキュー。タスクが追加された順番に実行する。厳密な順序制御が可能。
    - コンカレントディスパッチキュー
        - このキューのタスクは複数同時に実行される。完了する順序はタスクによって異なるため（処理時間が短いほど早い）、追加された順番とは異なる
### iOSにおけるキューの種類
- Main: シリアルキュー、メインスレッド、最初に届いた処理を最初に実行するFirst in First Out、ダウンロードなどの処理が重なるとフリーズを引き起こす
 - またはコンカレント（複数のタスクを同時に実行）に設定できます。
- タスク：実行する作業の単位です。これは同期的または非同期的にディスパッチキューに送られます。
- ディスパッチグループ：関連する複数のタスクをグループ化し、そのグループのタスクが全て完了したかどうかを監視するために使用されます。
- セマフォ：リソースへのアクセスを制御するために使用される、同期メカニズムです。


## メモ
- iOS15からasync{}キーワードが登場したものの、XCode13より廃止となりTask{}キーワードに変更された
- asyncDetached{}も同様に廃止となり、Task.detached{}に変更された


## バックグラウンドスレッドで実行したい時の記述方法
```
DispatchQeue.global().async{
    //データのダウンロード
    
    //メインスレッドにキューを切り替える
    DispatchQeue.global().async{
        //UIの更新
    }
}
```