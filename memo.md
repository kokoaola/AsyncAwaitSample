# Swift Concurrency

## スレッドとキュー
- スレッドとは
    - PCやスマホのCPUに対して、タスクを割り当てる仕組みのこと。
    - CPUを効率よく使わないと、アプリのパフォーマンスが低下する。
    - 複数のスレッドを独立させてCPUの割り当てることで、処理を同時に効率よく実行させていくことができ、パフォーマンスが向上する。

- キューとは
    - タスクが実行されるまでの待ち行列のこと。一般的には、「先入れ先出し」（FIFO: First In, First Out）の原則で、最初に届いた処理から順番に実行される。
    - タスクの待ち行列の管理、データの一時的な保管、タスクの順序付けなど、さまざまななプログラミング言語で広く使用されている概念
- スレッドは実行の「方法」に関わり、キューは実行される「タスクや順序」に関わる。スレッドとキューを組み合わせることで効率的なプログラムを作ることができる

## スレッドの種類
1. メインスレッド(UIスレッド)
    - アプリ内で発生するすべての画面描写を担当するスレッドのこと。
    - アプリのユーザーインターフェイスで発生するすべての処理は、メインスレッドで処理されるため、処理が集中するとフリーズしたりする。
2. バックグラウンドスレッド
    - データの読み込み、ネットワークリクエスト、重い計算など、時間がかかる処理を担当するスレッドのこと。
    - アプリケーションの裏側で動作するため、メインスレッドのパフォーマンスを妨げない。


## Concurrencyという考え
- Concurrencyとは：同時並行処理、非同期処理とも言われる。複数のタスクを同時に実行したり、高速で切り替えながら実行すること。サンドイッチを食べながらプログラミングをする。友達と電話をしながら洗濯物を畳む
- スクロールなどのUIイベントと、画像のダウンロードをメインスレッドで同時に実行すると、ダウンロードが完了するまでUIイベントがフリーズしてしまう。これをを阻止するために、UIイベントのみをメインスレッドで、ダウンロードはバックグラウンドスレッドで分担させて必要がある。このように効率よく仕事を割り当てることがConcurrency（同時並行処理、非同期処理）



## Grand Central Dispatch (GCD)
### GCDとは
Swift、Objective-Cに組み込まれている平行処理のためのAPIのこと。開発者がタスクを複数のスレッドに割り当ててることで、アプリケーションのパフォーマンスを向上させる。

### ディスパッチキューとは
- GCD内で使用される特別なキューのことで、シリアル（一度に1つのタスクを実行）またはコンカレント（複数のタスクを同時に実行）に設定できる
    - シリアルキュー
        - メインスレッド(UIスレッド)で使用されることが多く、UIの更新などに利用される。
        - FIFO（先入れ先出し）の原則に従うキュー。タスクが追加された順番に実行する。厳密な順序制御が可能であるため、タスク間の依存関係が重要な場合に有効。
        - 処理が集中するとUIがフリーズする可能性があるため、重い処理はバックグラウンドで行うべき。
    - グローバルキュー
        - コンカレントキューとも言われる。バックグラウンドスレッドで使用され、データの読み込みや計算などのCPUを多用する処理に適している。
        - このキューのタスクは複数同時に実行される。完了する順序はタスクによって異なるため（処理時間が短いほど早い）、追加された順番とは異なる可能性がある。これにより、効率的なマルチタスク処理が可能になる。
- GCDを活用することで、開発者は複雑なスレッド管理や同期処理について深く考えることなく、効率的な並行処理を実装できる。

### Swiftにおけるディスパッチキューの作成方法(簡単)
#### シリアルキューの作成方法
- 同期処理。上から順に実行され、タスク終了後に次のタスクが開始される
- メインスレッドで実行される
```Swift
//カスタムラベルでキューを作成
let queue = DispatchQueue(label: "SerialQueue")

//タスクの実行
queue.async{
    //最初のタスク
}

queue.async{
    //２番目のタスク
}
```

#### グローバルキューの作成方法
- 非同期で実行される。上から順に実行されるが、終了時間はバラバラになる
- メインスレッドで実行される
```Swift
//カスタムラベルでキューを作成
let queue = DispatchQueue(label: "ConcurrentQueue", attributes: .concurrent)

//タスクの実行
queue.async{
    //最初のタスク
}

queue.async{
    //２番目のタスク
}
```

#### バックグラウンドスレッドで処理を実行したい時の記述方法
```Swift
DispatchQeue.global().async{
    //データのダウンロード
}
```

#### バックグラウンドスレッドで処理を実行後、メインスレッドでUIを更新する
```Swift
DispatchQeue.global().async{
    //データのダウンロード
    
    //UIについての処理はメインスレッドにキューを切り替える
    DispatchQeue.global().async{
        //UIの更新
    }
}
```


## メモ
- iOS15からasync{}キーワードが登場したものの、XCode13より廃止となりTask{}キーワードに変更された
- asyncDetached{}も同様に廃止となり、Task.detached{}に変更された

